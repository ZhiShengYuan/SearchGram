# Production Docker Compose with Security Features
version: '3.8'

services:
  # Go Search Service (PRIVATE - only accessible via Nginx)
  searchgram-engine:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: searchgram-engine
    restart: unless-stopped
    environment:
      # Search Engine
      - ENGINE_TYPE=elasticsearch
      - ENGINE_ELASTICSEARCH_HOST=http://elasticsearch:9200
      - ENGINE_ELASTICSEARCH_USERNAME=elastic
      - ENGINE_ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
      - ENGINE_ELASTICSEARCH_INDEX=telegram
      - ENGINE_ELASTICSEARCH_SHARDS=3
      - ENGINE_ELASTICSEARCH_REPLICAS=1

      # Authentication (REQUIRED for production)
      - ENGINE_AUTH_ENABLED=true
      - ENGINE_AUTH_API_KEY=${API_KEY}

      # Server settings
      - ENGINE_SERVER_HOST=0.0.0.0
      - ENGINE_SERVER_PORT=8080
      - ENGINE_SERVER_READ_TIMEOUT=30s
      - ENGINE_SERVER_WRITE_TIMEOUT=30s

      # Logging
      - ENGINE_LOGGING_LEVEL=info
      - ENGINE_LOGGING_FORMAT=json

    depends_on:
      elasticsearch:
        condition: service_healthy

    networks:
      - private-network

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Security: Read-only filesystem (except temp)
    read_only: true
    tmpfs:
      - /tmp

    # Security: Drop all capabilities
    cap_drop:
      - ALL

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # Nginx Reverse Proxy (PUBLIC - only service exposed to internet)
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"    # HTTP (redirects to HTTPS)
      - "443:443"  # HTTPS
    volumes:
      # Nginx config
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

      # SSL certificates (get from Let's Encrypt)
      - ./ssl:/etc/nginx/ssl:ro

      # Logs
      - ./logs/nginx:/var/log/nginx

      # Certbot webroot for renewal
      - ./certbot/www:/var/www/certbot:ro

    depends_on:
      - searchgram-engine

    networks:
      - private-network
      - public-network

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    # Security: Read-only filesystem (except cache, logs, tmp)
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp

    # Security: Drop all capabilities except net_bind_service
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # Certbot for SSL certificate renewal
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./ssl:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - public-network

  # Elasticsearch (PRIVATE - not exposed to internet)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    container_name: elasticsearch
    restart: unless-stopped
    environment:
      # Single node setup
      - discovery.type=single-node

      # Security
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}

      # Memory settings
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"

      # Disable phone home
      - xpack.monitoring.collection.enabled=false

    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data

    networks:
      - private-network

    healthcheck:
      test: ["CMD-SHELL", "curl -f -u elastic:${ELASTIC_PASSWORD} http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    # Security: ulimits
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Optional: Fail2ban for brute force protection
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./fail2ban:/data
      - ./logs/nginx:/var/log/nginx:ro
    environment:
      - TZ=UTC
      - F2B_LOG_LEVEL=INFO
      - F2B_DB_PURGE_AGE=30d

networks:
  # Private network - no external access
  private-network:
    driver: bridge
    internal: true

  # Public network - exposed to internet
  public-network:
    driver: bridge

volumes:
  elasticsearch-data:
    driver: local
